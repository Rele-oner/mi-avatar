<!DOCTYPE html>
<html>
<head>
    <title>Mi Avatar Stream</title>
    <style>
        body { margin: 0; background-color: #00ff00; overflow: hidden; }
        #webcam { position: absolute; bottom: 10px; right: 10px; width: 200px; z-index: 10; transform: scaleX(-1); border-radius: 10px; }
    </style>
</head>
<body>
    <video id="webcam" autoplay playsinline></video>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

    <script>
        const videoElement = document.getElementById('webcam');
        const scene = new THREE.Scene();
        const camera3D = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(0, 1, 2);
        scene.add(light);
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        camera3D.position.set(0, 0, 3);

        let avatar, skeleton;
        const loader = new THREE.GLTFLoader();
        loader.load('avatar.glb', (gltf) => {
            avatar = gltf.scene;
            scene.add(avatar);
            avatar.position.y = -1.5;
            // Aquí detectamos los huesos para moverlos después
            skeleton = new THREE.SkeletonHelper(avatar);
        });

        const holistic = new Holistic({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`});
        holistic.setOptions({ modelComplexity: 1, refineFaceLandmarks: true });

        holistic.onResults((results) => {
            if (!avatar) return;
            
            // Movimiento básico de cabeza
            if (results.faceLandmarks) {
                const head = results.faceLandmarks[1]; 
                avatar.rotation.y = (head.x - 0.5) * -1;
                avatar.rotation.x = (head.y - 0.5);
            }
        });

        const camera = new Camera(videoElement, {
            onFrame: async () => { await holistic.send({image: videoElement}); },
            width: 640, height: 480
        });
        camera.start();

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera3D);
        }
        animate();
    </script>
</body>
</html>
