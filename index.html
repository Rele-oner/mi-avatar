<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>AI Avatar - Ultra 3D Mesh</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        body { margin: 0; background: #000; color: #00ffcc; font-family: 'Courier New', monospace; overflow: hidden; }
        .container { display: flex; width: 100vw; height: 100vh; }
        .view { flex: 1; position: relative; border: 1px solid #333; }
        video { position: absolute; width: 100%; height: 100%; object-fit: cover; opacity: 0.3; transform: rotateY(180deg); }
        canvas { width: 100%; height: 100%; }
        .label { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.8); padding: 5px; z-index: 10; font-size: 12px; }
    </style>
</head>
<body>

<div class="container">
    <div class="view">
        <div class="label">ENTRADA REAL</div>
        <video id="input_video"></video>
    </div>
    <div class="view" id="three_container">
        <div class="label">AVATAR 3D WIREFRAME</div>
    </div>
</div>

<script type="module">
    const videoElement = document.getElementById('input_video');
    const container = document.getElementById('three_container');

    // --- CONFIGURACIÓN THREE.JS (ESCENA 3D) ---
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    container.appendChild(renderer.domElement);

    // Material de malla (Wireframe) estilo neón
    const material = new THREE.MeshBasicMaterial({ 
        color: 0x00ffff, 
        wireframe: true, 
        transparent: true, 
        opacity: 0.8 
    });

    // Creamos partes del cuerpo con volúmenes 3D reales
    const createPart = (geo) => new THREE.Mesh(geo, material);
    const head = createPart(new THREE.IcosahedronGeometry(0.25, 3));
    const torso = createPart(new THREE.CylinderGeometry(0.3, 0.2, 0.7, 8));
    const lArm = createPart(new THREE.CylinderGeometry(0.08, 0.08, 0.6, 6));
    const rArm = createPart(new THREE.CylinderGeometry(0.08, 0.08, 0.6, 6));
    
    scene.add(head, torso, lArm, rArm);
    camera.position.z = 2;

    function onResults(results) {
        if (!results.poseLandmarks) return;

        const landmarks = results.poseLandmarks;

        // Mapeo de movimiento de MediaPipe a coordenadas 3D de Three.js
        const to3D = (lm) => ({
            x: (lm.x - 0.5) * 2,
            y: -(lm.y - 0.5) * 2,
            z: -lm.z
        });

        // 1. Posicionar Cabeza
        const nose = to3D(landmarks[0]);
        head.position.set(nose.x, nose.y, nose.z);

        // 2. Posicionar Torso
        const lShoulder = to3D(landmarks[11]);
        const rShoulder = to3D(landmarks[12]);
        torso.position.set((lShoulder.x + rShoulder.x)/2, (lShoulder.y - 0.35), 0);

        // 3. Brazo Derecho (Malla conectada hombro-codo)
        const rElbow = to3D(landmarks[14]);
        rArm.position.set((rShoulder.x + rElbow.x)/2, (rShoulder.y + rElbow.y)/2, 0);
        rArm.lookAt(rElbow.x, rElbow.y, 0);
        rArm.rotation.x += Math.PI / 2;

        renderer.render(scene, camera);
    }

    // --- CONFIGURACIÓN MEDIAPIPE ---
    const holistic = new Holistic({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`});
    holistic.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5 });
    holistic.onResults(onResults);

    const cam = new Camera(videoElement, {
        onFrame: async () => { await holistic.send({image: videoElement}); },
        width: 640, height: 480
    });
    cam.start();
</script>

</body>
</html>
