<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AI Avatar - V43 GHOST</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; color: #00ffcc; font-family: monospace; }
        canvas { width: 100vw; height: 100vh; transform: rotateY(180deg); position: absolute; z-index: 1; }
        #v { position: fixed; bottom: 10px; right: 10px; width: 120px; opacity: 0.5; transform: rotateY(180deg); border: 1px solid #00ffcc; z-index: 2; }
        #ui { position: fixed; top: 10px; left: 10px; z-index: 3; font-size: 11px; }
    </style>
</head>
<body>
    <div id="ui">PROTOTIPO_V43 // ESTADO: <span id="st">INICIALIZANDO...</span></div>
    <video id="v" autoplay playsinline></video>
    <canvas id="out"></canvas>

<script>
    const video = document.getElementById('v');
    const canvas = document.getElementById('out');
    const ctx = canvas.getContext('2d');
    const status = document.getElementById('st');
    let latestFace = null;

    // 1. ARRANCAR CÁMARA (Resolución de seguridad)
    async function init() {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 480, height: 360 } });
        video.srcObject = stream;
        
        const faceMesh = new FaceMesh({
            locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`
        });

        faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: false, minDetectionConfidence: 0.5 });
        
        faceMesh.onResults(res => {
            if (res.multiFaceLandmarks) {
                latestFace = res.multiFaceLandmarks[0];
                status.innerText = "SINCRO_ACTIVA";
                status.style.color = "#00ffcc";
            }
        });

        // Bucle de IA (Separado del dibujo)
        async function detectionLoop() {
            if (video.readyState >= 2) {
                await faceMesh.send({image: video});
            }
            // Pequeña pausa para dejar que el navegador respire
            setTimeout(detectionLoop, 30);
        }
        detectionLoop();
        renderLoop();
    }

    // 2. BUCLE DE DIBUJO (Independiente y a 60FPS)
    function renderLoop() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (latestFace) {
            ctx.strokeStyle = "#00ffcc";
            ctx.lineWidth = 1.5;
            
            // Dibujamos la silueta esencial
            const silhouette = [10, 338, 297, 332, 284, 251, 389, 356, 454, 323, 361, 288, 397, 365, 379, 378, 400, 377, 152, 148, 176, 149, 150, 136, 172, 58, 132, 93, 234, 127, 162, 21, 54, 103, 67, 109];
            
            ctx.beginPath();
            silhouette.forEach((idx, i) => {
                const p = latestFace[idx];
                const x = p.x * canvas.width;
                const y = p.y * canvas.height;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.closePath();
            ctx.stroke();

            // Ojos: El indicador de vida
            ctx.fillStyle = "#fff";
            [468, 473].forEach(idx => {
                const p = latestFace[idx];
                ctx.beginPath();
                ctx.arc(p.x * canvas.width, p.y * canvas.height, 3, 0, 7);
                ctx.fill();
            });
        }
        requestAnimationFrame(renderLoop);
    }

    init().catch(e => status.innerText = "ERROR: " + e);
</script>
</body>
</html>
