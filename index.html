<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AI Avatar - V38 ZERO</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; }
        canvas { width: 100vw; height: 100vh; transform: rotateY(180deg); }
        video { display: none; }
        #emergency-hud { position: absolute; top: 10px; left: 10px; color: #ff0055; font-family: monospace; font-size: 10px; }
    </style>
</head>
<body>
    <div id="emergency-hud">CORE_V38: PERFORMANCE_MODE_ACTIVE</div>
    <canvas id="out"></canvas>
    <video id="v" playsinline></video>

<script type="module">
    const video = document.getElementById('v');
    const canvas = document.getElementById('out');
    const ctx = canvas.getContext('2d', { desynchronized: true, alpha: false });

    // Puntos clave mínimos para evitar el colapso (Estructura ósea facial)
    const MIN_MESH = [
        [10, 338, 297, 332, 284, 251, 389, 356, 454, 323, 361, 288, 397, 365, 379, 378, 400, 377, 152, 148, 176, 149, 150, 136, 172, 58, 132, 93, 234, 127, 162, 21, 54, 103, 67, 109, 10]
    ];

    function onResults(res) {
        // Ajuste de resolución de dibujo para máxima velocidad
        if (canvas.width !== 320) { canvas.width = 320; canvas.height = 240; }
        
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        if (res.multiFaceLandmarks && res.multiFaceLandmarks[0]) {
            const face = res.multiFaceLandmarks[0];

            // Dibujo ultra-veloz de contorno
            ctx.strokeStyle = "#00ffcc";
            ctx.lineWidth = 1;
            ctx.beginPath();
            MIN_MESH[0].forEach((idx, i) => {
                const p = face[idx];
                if (i === 0) ctx.moveTo(p.x * 320, p.y * 240);
                else ctx.lineTo(p.x * 320, p.y * 240);
            });
            ctx.stroke();

            // Ojos: El alma del avatar (puntos simples)
            ctx.fillStyle = "#fff";
            [468, 473].forEach(idx => {
                const p = face[idx];
                ctx.fillRect(p.x * 320 - 1, p.y * 240 - 1, 2, 2);
            });
        }
    }

    const faceMesh = new FaceMesh({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`});
    faceMesh.setOptions({
        maxNumFaces: 1,
        refineLandmarks: false,
        minDetectionConfidence: 0.4,
        minTrackingConfidence: 0.4
    });
    faceMesh.onResults(onResults);

    const camera = new Camera(video, {
        onFrame: async () => { await faceMesh.send({image: video}); },
        width: 320, height: 240 // Resolución mínima absoluta
    });
    camera.start();
</script>
</body>
</html>
