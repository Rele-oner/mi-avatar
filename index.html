<!DOCTYPE html>
<html>
<head>
    <title>Avatar Ultra-Preciso V2</title>
    <style>
        body { margin: 0; background-color: #00ff00; overflow: hidden; }
        #webcam { position: absolute; bottom: 10px; right: 10px; width: 160px; transform: scaleX(-1); border: 2px solid white; border-radius: 5px; opacity: 0.5; }
        #ui-container { position: absolute; top: 10px; left: 10px; display: flex; flex-direction: column; gap: 8px; z-index: 100; }
        .btn-reset { padding: 10px 15px; background: #ff4757; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #status { color: white; background: rgba(0,0,0,0.7); padding: 8px; font-family: sans-serif; border-radius: 5px; font-size: 12px; }
    </style>
</head>
<body>
    <div id="ui-container">
        <div id="status">Iniciando Motor de Alta Precisi칩n...</div>
        <button class="btn-reset" onclick="location.reload()">游댃 RECALIBRAR TODO</button>
    </div>
    <video id="webcam" autoplay playsinline></video>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        const videoElement = document.getElementById('webcam');
        const status = document.getElementById('status');

        // Escena y Render
        const scene = new THREE.Scene();
        const camera3D = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const mat = new THREE.MeshNormalMaterial();
        const avatar = new THREE.Group();
        
        // --- CONSTRUCCI칍N DEL ESQUELETO PRECISO ---
        const cabeza = new THREE.Mesh(new THREE.BoxGeometry(0.35, 0.45, 0.3), mat);
        avatar.add(cabeza);

        const tronco = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.7, 0.2), mat);
        tronco.position.y = -0.6;
        avatar.add(tronco);

        // Brazos segmentados (Brazo y Antebrazo)
        function crearBrazo(lado) {
            const grupo = new THREE.Group();
            const superior = new THREE.Mesh(new THREE.CylinderGeometry(0.04, 0.03, 0.4), mat);
            superior.geometry.translate(0, -0.2, 0);
            
            const inferior = new THREE.Mesh(new THREE.CylinderGeometry(0.03, 0.02, 0.4), mat);
            inferior.geometry.translate(0, -0.2, 0);
            inferior.position.y = -0.4;
            
            grupo.add(superior);
            grupo.add(inferior);
            return { grupo, superior, inferior };
        }

        const bDer = crearBrazo(-1); bDer.grupo.position.set(-0.3, -0.3, 0);
        const bIzq = crearBrazo(1); bIzq.grupo.position.set(0.3, -0.3, 0);
        avatar.add(bDer.grupo, bIzq.grupo);

        // Dedos (Puntos de referencia)
        const dedos = [];
        const dedoGeo = new THREE.SphereGeometry(0.02);
        const dedoMat = new THREE.MeshBasicMaterial({color: 0xffffff});
        for(let i=0; i<10; i++) {
            const d = new THREE.Mesh(dedoGeo, dedoMat);
            scene.add(d);
            dedos.push(d);
        }

        scene.add(avatar);
        camera3D.position.set(0, -0.4, 2);

        // --- L칍GICA DE TRACKING AVANZADO ---
        const holistic = new Holistic({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`});
        holistic.setOptions({ 
            modelComplexity: 1, // Cambia a 2 para m치xima precisi칩n si tu PC es potente
            smoothLandmarks: true,
            refineFaceLandmarks: true,
            minDetectionConfidence: 0.7,
            minTrackingConfidence: 0.7 
        });

        holistic.onResults((res) => {
            status.innerText = "Tracking: ALTA PRECISI칍N";

            // 1. Rostro con suavizado
            if (res.faceLandmarks) {
                const n = res.faceLandmarks[1];
                cabeza.rotation.y = THREE.MathUtils.lerp(cabeza.rotation.y, (n.x - 0.5) * -1.5, 0.2);
                cabeza.rotation.x = THREE.MathUtils.lerp(cabeza.rotation.x, (n.y - 0.5) * 1.5, 0.2);
            }

            // 2. Brazos y Codos (Cinem치tica)
            if (res.poseLandmarks) {
                actualizarMiembro(res.poseLandmarks[11], res.poseLandmarks[13], res.poseLandmarks[15], bDer);
                actualizarMiembro(res.poseLandmarks[12], res.poseLandmarks[14], res.poseLandmarks[16], bIzq);
            }

            // 3. Manos (Puntas de los dedos)
            if (res.rightHandLandmarks) {
                [4, 8, 12, 16, 20].forEach((pt, i) => {
                    dedos[i].position.set((res.rightHandLandmarks[pt].x-0.5)*-2.5, (res.rightHandLandmarks[pt].y-0.5)*-2.5, 0);
                });
            }
        });

        function actualizarMiembro(h, c, m, miembro) {
            const angSuperior = Math.atan2(c.y - h.y, c.x - h.x) + Math.PI/2;
            miembro.grupo.rotation.z = THREE.MathUtils.lerp(miembro.grupo.rotation.z, angSuperior, 0.3);
            
            const angInferior = Math.atan2(m.y - c.y, m.x - c.x) - angSuperior + Math.PI/2;
            miembro.inferior.rotation.z = THREE.MathUtils.lerp(miembro.inferior.rotation.z, angInferior, 0.3);
        }

        const camera = new Camera(videoElement, {
            onFrame: async () => { await holistic.send({image: videoElement}); },
            width: 1280, height: 720
        });
        camera.start();

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera3D);
        }
        animate();
    </script>
</body>
</html>
