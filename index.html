<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AI Avatar - V21.1 Ultra-Estable</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Courier New', monospace; color: #00ffcc; }
        .app-container { display: flex; width: 100vw; height: 100vh; }
        .sidebar { width: 200px; background: rgba(0,10,10,0.95); border-right: 1px solid #00ffcc33; padding: 25px; z-index: 10; }
        .main-view { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; }
        canvas { max-width: 100%; max-height: 100%; transform: rotateY(180deg); border: 1px solid #00ffcc11; }
        video { display: none; }
        .stat { margin-bottom: 20px; }
        .label { font-size: 9px; opacity: 0.5; letter-spacing: 1px; }
        .val { font-size: 14px; font-weight: bold; text-shadow: 0 0 5px #00ffcc; }
        #loading-overlay { position: absolute; inset: 0; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; transition: 0.5s; }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="val" id="load-msg">CARGANDO NÚCLEO...</div>
        <div class="label" style="margin-top:10px">ESTABLECIENDO ENLACE NEURAL</div>
    </div>

    <div class="app-container">
        <div class="sidebar">
            <div class="stat"><div class="label">LINK_STATUS</div><div class="val" id="st">OFFLINE</div></div>
            <div class="stat"><div class="label">DATA_RATE</div><div class="val" id="fps">0 FPS</div></div>
            <div class="stat"><div class="label">EYE_SYNC</div><div class="val" id="iris">--</div></div>
        </div>
        <div class="main-view">
            <canvas id="out"></canvas>
            <video id="v" playsinline></video>
        </div>
    </div>

<script type="module">
    const video = document.getElementById('v');
    const canvas = document.getElementById('out');
    const ctx = canvas.getContext('2d');
    const loadOverlay = document.getElementById('loading-overlay');
    
    let lastTime = 0;
    let isProcessing = false;

    function onResults(res) {
        if (loadOverlay) loadOverlay.style.opacity = '0';
        setTimeout(() => loadOverlay?.remove(), 500);

        canvas.width = video.videoWidth || 640;
        canvas.height = video.videoHeight || 480;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // --- RENDERIZADO OPTIMIZADO ---
        if (res.faceLandmarks) {
            // 1. Iris Protocol (Brillo en ojos)
            [468, 473].forEach(i => {
                const p = res.faceLandmarks[i];
                ctx.beginPath();
                ctx.arc(p.x * canvas.width, p.y * canvas.height, 4, 0, 7);
                ctx.fillStyle = '#fff';
                ctx.shadowBlur = 15; ctx.shadowColor = '#00ffcc';
                ctx.fill();
            });

            // 2. Contorno Facial (Sin malla interna para ahorrar CPU)
            drawConnectors(ctx, res.faceLandmarks, FACEMESH_FACE_OVAL, {color: '#00ffcc', lineWidth: 2});
            document.getElementById('iris').innerText = "SYNC_OK";
        }

        // 3. Manos (Solo si aparecen)
        const handStyle = {color: '#fff', lineWidth: 2};
        if (res.leftHandLandmarks) drawConnectors(ctx, res.leftHandLandmarks, HAND_CONNECTIONS, handStyle);
        if (res.rightHandLandmarks) drawConnectors(ctx, res.rightHandLandmarks, HAND_CONNECTIONS, handStyle);

        // Monitor de sistema
        const now = performance.now();
        const currentFps = Math.round(1000 / (now - lastTime));
        document.getElementById('fps').innerText = currentFps + " FPS";
        document.getElementById('st').innerText = "STABLE";
        lastTime = now;
        isProcessing = false;
    }

    const holistic = new Holistic({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${f}`});
    
    holistic.setOptions({
        modelComplexity: 0, // Nivel Lite para evitar bloqueos
        smoothLandmarks: true,
        minDetectionConfidence: 0.6,
        minTrackingConfidence: 0.5
    });

    holistic.onResults(onResults);

    const camera = new Camera(video, {
        onFrame: async () => {
            if (isProcessing) return; // SKIP FRAME si el motor está ocupado
            isProcessing = true;
            await holistic.send({image: video});
        },
        width: 640, height: 480
    });

    document.getElementById('load-msg').innerText = "INICIANDO CÁMARA...";
    camera.start().catch(err => {
        document.getElementById('load-msg').innerText = "ERROR DE ACCESO";
        console.error(err);
    });
</script>
</body>
</html>
