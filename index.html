<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AI Avatar - V39 RESET</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; color: #00ffcc; font-family: monospace; }
        canvas { width: 100vw; height: 100vh; transform: rotateY(180deg); }
        video { position: fixed; top: 0; left: 0; width: 100px; opacity: 0.3; transform: rotateY(180deg); }
        #msg { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
    </style>
</head>
<body>
    <div id="msg">CARGANDO NÚCLEO...</div>
    <video id="v" autoplay playsinline></video>
    <canvas id="out"></canvas>

<script>
    const video = document.getElementById('v');
    const canvas = document.getElementById('out');
    const ctx = canvas.getContext('2d');
    const msg = document.getElementById('msg');

    // 1. ARRANCAR CÁMARA NATIVA (Sin librerías externas)
    navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } })
    .then(stream => {
        video.srcObject = stream;
        video.onloadedmetadata = () => {
            video.play();
            msg.style.display = 'none';
            startAI();
        };
    })
    .catch(err => msg.innerText = "ERROR DE CÁMARA: " + err);

    function startAI() {
        const faceMesh = new FaceMesh({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
        });

        faceMesh.setOptions({
            maxNumFaces: 1,
            refineLandmarks: false,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        faceMesh.onResults(res => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (res.multiFaceLandmarks && res.multiFaceLandmarks[0]) {
                const face = res.multiFaceLandmarks[0];
                ctx.strokeStyle = "#00ffcc";
                ctx.lineWidth = 2;
                
                // Dibujo simplificado de ojos y boca para verificar movimiento
                [ [33, 133], [263, 362], [13, 14] ].forEach(pair => {
                    ctx.beginPath();
                    const p1 = face[pair[0]];
                    const p2 = face[pair[1]];
                    ctx.moveTo(p1.x * canvas.width, p1.y * canvas.height);
                    ctx.lineTo(p2.x * canvas.width, p2.y * canvas.height);
                    ctx.stroke();
                });
            }
        });

        // 2. BUCLE DE PROCESAMIENTO MANUAL
        async function detect() {
            await faceMesh.send({image: video});
            requestAnimationFrame(detect);
        }
        detect();
    }
</script>
</body>
</html>
