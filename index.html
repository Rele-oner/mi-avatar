<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AI Avatar - V22 Light-Core</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Courier New', monospace; color: #00ffcc; }
        .app { display: flex; width: 100vw; height: 100vh; }
        .sidebar { width: 220px; background: #001111; border-right: 1px solid #00ffcc44; padding: 20px; }
        .main { flex: 1; position: relative; background: #000; display: flex; align-items: center; justify-content: center; }
        canvas { height: 90vh; transform: rotateY(180deg); border: 1px solid #00ffcc22; }
        video { display: none; }
        .stat { margin-bottom: 20px; }
        .label { font-size: 10px; opacity: 0.5; }
        .val { font-size: 14px; font-weight: bold; color: #fff; }
        #boot { position: absolute; inset: 0; background: #000; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>
    <div id="boot">
        <div class="val" id="msg">CARGANDO NÚCLEO V22...</div>
        <div class="label" style="margin-top: 10px;">OPTIMIZANDO RECURSOS</div>
    </div>

    <div class="app">
        <div class="sidebar">
            <div class="stat"><div class="label">ENGINE</div><div class="val" id="status">OFFLINE</div></div>
            <div class="stat"><div class="label">PERFORMANCE</div><div class="val" id="fps">0 FPS</div></div>
            <div class="stat"><div class="label">IRIS_SYNC</div><div class="val" id="iris">--</div></div>
        </div>
        <div class="main">
            <canvas id="canvas"></canvas>
            <video id="video" playsinline></video>
        </div>
    </div>

<script type="module">
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const bootMsg = document.getElementById('msg');
    
    let lastTime = 0;

    function onResults(res) {
        document.getElementById('boot').style.display = 'none';
        
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (res.multiFaceLandmarks && res.multiFaceLandmarks.length > 0) {
            const face = res.multiFaceLandmarks[0];

            // RENDER IRIS (Puntos 468 y 473)
            ctx.fillStyle = "#fff";
            [468, 473].forEach(idx => {
                const p = face[idx];
                ctx.beginPath();
                ctx.arc(p.x * canvas.width, p.y * canvas.height, 4, 0, 7);
                ctx.shadowBlur = 15; ctx.shadowColor = "#00ffcc";
                ctx.fill();
            });

            // RENDER CONTORNO (Simplificado para evitar lag)
            ctx.strokeStyle = "#00ffcc";
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            // Dibujamos un óvalo simplificado usando algunos puntos clave
            const ovalIdx = [10, 338, 297, 332, 284, 251, 389, 356, 454, 323, 361, 288, 397, 365, 379, 378, 400, 377, 152, 148, 176, 149, 150, 136, 172, 58, 132, 93, 234, 127, 162, 21, 54, 103, 67, 109];
            ovalIdx.forEach((idx, i) => {
                const p = face[idx];
                if(i === 0) ctx.moveTo(p.x * canvas.width, p.y * canvas.height);
                else ctx.lineTo(p.x * canvas.width, p.y * canvas.height);
            });
            ctx.closePath();
            ctx.stroke();

            document.getElementById('iris').innerText = "LOCKED";
        }

        const now = performance.now();
        document.getElementById('fps').innerText = Math.round(1000 / (now - lastTime)) + " FPS";
        document.getElementById('status').innerText = "STABLE";
        lastTime = now;
    }

    const faceMesh = new FaceMesh({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
    });

    faceMesh.setOptions({
        maxNumFaces: 1,
        refineLandmarks: true, // Esto activa el Iris Tracking detallado
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });

    faceMesh.onResults(onResults);

    const camera = new Camera(video, {
        onFrame: async () => {
            await faceMesh.send({image: video});
        },
        width: 640, height: 480
    });

    bootMsg.innerText = "ENCENDIENDO CÁMARA...";
    camera.start().catch(e => {
        bootMsg.innerText = "ERROR: PERMISO DENEGADO";
    });
</script>
</body>
</html>
