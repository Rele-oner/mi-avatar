<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AI Avatar - Neural Master v16</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: monospace; }
        .grid { display: flex; width: 100vw; height: 100vh; }
        .view { flex: 1; position: relative; border-right: 1px solid #111; }
        canvas { width: 100%; height: 100%; transform: rotateY(180deg); object-fit: contain; }
        video { display: none; }
        .ui { position: absolute; top: 15px; left: 15px; z-index: 10; display: flex; flex-direction: column; gap: 5px; }
        .tag { color: #00ffcc; font-size: 10px; background: rgba(0,0,0,0.8); padding: 5px; border: 1px solid currentColor; }
        .controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; z-index: 20; }
        button { background: #000; border: 1px solid #00ffcc; color: #00ffcc; padding: 5px 15px; cursor: pointer; font-family: monospace; font-size: 12px; }
        button:hover { background: #00ffcc; color: #000; }
    </style>
</head>
<body>
    <div class="controls">
        <button onclick="setProfile('#00ffcc')">CYAN</button>
        <button onclick="setProfile('#ff00ff')">MAGENTA</button>
        <button onclick="setProfile('#ffaa00')">AMBER</button>
    </div>
    <div class="grid">
        <div class="view"><div class="ui"><div class="tag" id="tag-color">PROFILE: CYAN_ACTIVE</div></div><video id="vid"></video><canvas id="c_in"></canvas></div>
        <div class="view"><div class="ui"><div class="tag">NEURAL_OUTPUT_V16</div></div><canvas id="c_out"></canvas></div>
    </div>

<script type="module">
    let activeColor = '#00ffcc';
    window.setProfile = (color) => { 
        activeColor = color; 
        document.querySelectorAll('.tag, button').forEach(el => el.style.color = color);
        document.querySelectorAll('button').forEach(el => el.style.borderColor = color);
        document.getElementById('tag-color').innerText = `PROFILE: ${color === '#00ffcc' ? 'CYAN' : color === '#ff00ff' ? 'MAGENTA' : 'AMBER'}_ACTIVE`;
    };

    const video = document.getElementById('vid');
    const ctxOut = document.getElementById('c_out').getContext('2d');
    const particles = [];

    function drawBackground(ctx, w, h, intensity) {
        ctx.strokeStyle = activeColor + '11'; // Muy transparente
        ctx.lineWidth = 0.5;
        const spacing = 40 + (intensity * 20); // La rejilla se expande con la intensidad
        for(let x=0; x<w; x+=spacing) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); }
        for(let y=0; y<h; y+=spacing) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }
    }

    function onResults(res) {
        const w = ctxOut.canvas.width = video.videoWidth;
        const h = ctxOut.canvas.height = video.videoHeight;
        
        // Calcular intensidad (boca abierta)
        let intensity = 0;
        if(res.faceLandmarks) {
            const d = Math.abs(res.faceLandmarks[13].y - res.faceLandmarks[14].y);
            intensity = Math.min(d * 15, 1);
        }

        ctxOut.fillStyle = '#000';
        ctxOut.fillRect(0, 0, w, h);
        
        drawBackground(ctxOut, w, h, intensity);

        ctxOut.save();
        if(intensity > 0.4) {
            ctxOut.shadowBlur = 20 * intensity;
            ctxOut.shadowColor = activeColor;
        }

        // Renderizado de Cuerpo y Cara con el color activo
        if (res.poseLandmarks) drawConnectors(ctxOut, res.poseLandmarks, POSE_CONNECTIONS, {color: activeColor, lineWidth: 2});
        if (res.faceLandmarks) drawConnectors(ctxOut, res.faceLandmarks, FACEMESH_FACE_OVAL, {color: activeColor, lineWidth: 2});
        
        const handStyle = {color: intensity > 0.5 ? activeColor : '#fff', lineWidth: 2};
        if (res.rightHandLandmarks) drawConnectors(ctxOut, res.rightHandLandmarks, HAND_CONNECTIONS, handStyle);
        if (res.leftHandLandmarks) drawConnectors(ctxOut, res.leftHandLandmarks, HAND_CONNECTIONS, handStyle);

        ctxOut.restore();
    }

    const holistic = new Holistic({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${f}`});
    holistic.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5 });
    holistic.onResults(onResults);

    const camera = new Camera(video, { onFrame: async () => { await holistic.send({image: video}); }, width: 640, height: 480 });
    camera.start();
</script>
</body>
</html>
