<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Face Tracker - Captura de Movimiento</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_landmarker/face_landmarker.js" crossorigin="anonymous"></script>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; display: flex; flex-direction: column; align-items: center; }
        .container { position: relative; margin-top: 20px; }
        video, canvas { position: absolute; left: 0; top: 0; border-radius: 10px; }
        #webcam { transform: rotateY(180deg); }
        #output_canvas { transform: rotateY(180deg); }
        .status { margin-top: 500px; padding: 20px; background: #1e1e1e; border-radius: 8px; width: 80%; max-width: 600px; }
        .metric { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding: 5px 0; }
    </style>
</head>
<body>

    <h1>Captura de Movimiento Facial AI</h1>
    <p id="loading">Cargando modelos de IA...</p>

    <div class="container">
        <video id="webcam" width="640" height="480" autoplay playsinline></video>
        <canvas id="output_canvas" width="640" height="480"></canvas>
    </div>

    <div class="status">
        <h3>Datos en tiempo real:</h3>
        <div class="metric"><span>Boca abierta:</span> <span id="mouthStatus">-</span></div>
        <div class="metric"><span>Ojo Izquierdo:</span> <span id="eyeLStatus">-</span></div>
        <div class="metric"><span>Ojo Derecho:</span> <span id="eyeRStatus">-</span></div>
        <div class="metric"><span>Sonrisa:</span> <span id="smileStatus">-</span></div>
    </div>

    <script type="module">
        import { FaceLandmarker, FilesetResolver, DrawingUtils } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3";

        const video = document.getElementById("webcam");
        const canvasElement = document.getElementById("output_canvas");
        const canvasCtx = canvasElement.getContext("center");
        const mouthStatus = document.getElementById("mouthStatus");
        const smileStatus = document.getElementById("smileStatus");

        let faceLandmarker;
        let lastVideoTime = -1;

        async function setupFaceLandmarker() {
            const filesetResolver = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
            faceLandmarker = await FaceLandmarker.createFromOptions(filesetResolver, {
                baseOptions: { modelAssetPath: `https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task`, delegate: "GPU" },
                outputFaceBlendshapes: true,
                runningMode: "VIDEO",
                numFaces: 1
            });
            document.getElementById("loading").innerText = "IA Lista. Activa tu cÃ¡mara.";
            startCamera();
        }

        function startCamera() {
            navigator.mediaDevices.getUserMedia({ video: true }).then((stream) => {
                video.srcObject = stream;
                video.addEventListener("loadeddata", predictWebcam);
            });
        }

        async function predictWebcam() {
            let startTimeMs = performance.now();
            if (lastVideoTime !== video.currentTime) {
                lastVideoTime = video.currentTime;
                const results = faceLandmarker.detectForVideo(video, startTimeMs);

                const canvasCtx = canvasElement.getContext('2d');
                canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
                
                const drawingUtils = new DrawingUtils(canvasCtx);

                if (results.faceLandmarks) {
                    for (const landmarks of results.faceLandmarks) {
                        drawingUtils.drawConnectors(landmarks, FaceLandmarker.FACE_LANDMARKS_TESSELATION, {color: "#C0C0C070", lineWidth: 1});
                        drawingUtils.drawConnectors(landmarks, FaceLandmarker.FACE_LANDMARKS_RIGHT_EYE, {color: "#FF3030"});
                        drawingUtils.drawConnectors(landmarks, FaceLandmarker.FACE_LANDMARKS_LEFT_EYE, {color: "#30FF30"});
                        drawingUtils.drawConnectors(landmarks, FaceLandmarker.FACE_LANDMARKS_MOUTH, {color: "#E0E0E0"});
                    }
                }

                if (results.faceBlendshapes && results.faceBlendshapes.length > 0) {
                    const shapes = results.faceBlendshapes[0].categories;
                    
                    // Mapeo de movimientos clave
                    const mouthOpen = shapes.find(s => s.categoryName === "jawOpen").score;
                    const smileL = shapes.find(s => s.categoryName === "mouthSmileLeft").score;
                    const smileR = shapes.find(s => s.categoryName === "mouthSmileRight").score;
                    const eyeL = shapes.find(s => s.categoryName === "eyeBlinkLeft").score;
                    const eyeR = shapes.find(s => s.categoryName === "eyeBlinkRight").score;

                    document.getElementById("mouthStatus").innerText = mouthOpen > 0.2 ? "Abierta" : "Cerrada";
                    document.getElementById("smileStatus").innerText = (smileL + smileR) / 2 > 0.3 ? "Sonriendo" : "Neutral";
                    document.getElementById("eyeLStatus").innerText = eyeL > 0.4 ? "Cerrado" : "Abierto";
                    document.getElementById("eyeRStatus").innerText = eyeR > 0.4 ? "Cerrado" : "Abierto";
                }
            }
            window.requestAnimationFrame(predictWebcam);
        }

        setupFaceLandmarker();
    </script>
</body>
</html>
