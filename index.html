<!DOCTYPE html>
<html>
<head>
    <title>Rotoscopia Inteligente - Movimiento Humano</title>
    <style>
        body { margin: 0; background-color: #00ff00; overflow: hidden; }
        #webcam { position: absolute; bottom: 10px; right: 10px; width: 200px; transform: scaleX(-1); border: 2px solid white; border-radius: 10px; }
        #status { position: absolute; top: 10px; left: 10px; color: white; background: rgba(0,0,0,0.8); padding: 12px; font-family: sans-serif; border-radius: 8px; }
    </style>
</head>
<body>
    <div id="status">Estado: <span id="info">Esperando...</span></div>
    <video id="webcam" autoplay playsinline></video>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        const videoElement = document.getElementById('webcam');
        const info = document.getElementById('info');

        const scene = new THREE.Scene();
        const camera3D = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const material = new THREE.MeshNormalMaterial();
        
        // Función para crear partes del cuerpo que pueden desaparecer
        const crearParte = (geo) => {
            const mesh = new THREE.Mesh(geo, material);
            mesh.visible = false; // Empiezan invisibles
            scene.add(mesh);
            return mesh;
        };

        const cabeza = crearParte(new THREE.BoxGeometry(0.35, 0.45, 0.3));
        const tronco = crearParte(new THREE.BoxGeometry(0.6, 0.8, 0.2));
        
        const brazoD_S = crearParte(new THREE.CylinderGeometry(0.05, 0.04, 1));
        const brazoD_I = crearParte(new THREE.CylinderGeometry(0.04, 0.03, 1));
        const brazoI_S = crearParte(new THREE.CylinderGeometry(0.05, 0.04, 1));
        const brazoI_I = crearParte(new THREE.CylinderGeometry(0.04, 0.03, 1));

        camera3D.position.z = 3.5;

        const holistic = new Holistic({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`});
        holistic.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });

        holistic.onResults((res) => {
            if (!res.poseLandmarks) {
                info.innerText = "FUERA DE CÁMARA";
                [cabeza, tronco, brazoD_S, brazoD_I, brazoI_S, brazoI_I].forEach(p => p.visible = false);
                return;
            }
            info.innerText = "TRACKING ACTIVO";
            const p = res.poseLandmarks;

            const to3D = (pt) => ({
                x: (pt.x - 0.5) * -4,
                y: (pt.y - 0.5) * -4,
                z: pt.z * -2,
                v: pt.visibility // Importante: nivel de confianza
            });

            // Lógica de Visibilidad y Posición
            // Cabeza
            if (p[0].visibility > 0.5) {
                cabeza.visible = true;
                const n = to3D(p[0]);
                cabeza.position.set(n.x, n.y + 0.3, n.z);
            } else { cabeza.visible = false; }

            // Tronco (Hombros 11 y 12)
            if (p[11].visibility > 0.5 && p[12].visibility > 0.5) {
                tronco.visible = true;
                const h1 = to3D(p[11]); const h2 = to3D(p[12]);
                tronco.position.set((h1.x + h2.x)/2, (h1.y + h2.y)/2 - 0.4, (h1.z + h2.z)/2);
            } else { tronco.visible = false; }

            // Brazos: Solo aparecen si la confianza es alta
            updateBone(brazoD_S, to3D(p[11]), to3D(p[13]), 0.5); // Hombro-Codo D
            updateBone(brazoD_I, to3D(p[13]), to3D(p[15]), 0.5); // Codo-Muñeca D
            updateBone(brazoI_S, to3D(p[12]), to3D(p[14]), 0.5); // Hombro-Codo I
            updateBone(brazoI_I, to3D(p[14]), to3D(p[16]), 0.5); // Codo-Muñeca I
        });

        function updateBone(mesh, start, end, threshold) {
            // Si alguno de los dos puntos no es visible, ocultamos el hueso
            if (start.v < threshold || end.v < threshold) {
                mesh.visible = false;
                return;
            }
            
            mesh.visible = true;
            const startV = new THREE.Vector3(start.x, start.y, start.z);
            const endV = new THREE.Vector3(end.x, end.y, end.z);
            const dir = new THREE.Vector3().subVectors(endV, startV);
            
            mesh.scale.y = dir.length();
            mesh.position.copy(startV).add(dir.clone().multiplyScalar(0.5));
            mesh.quaternion.setFromUnitVectors(new THREE.Vector3(0, 1, 0), dir.clone().normalize());
        }

        const camera = new Camera(videoElement, {
            onFrame: async () => { await holistic.send({image: videoElement}); },
            width: 1280, height: 720
        });
        camera.start();

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera3D);
        }
        animate();
    </script>
</body>
</html>
