<!DOCTYPE html>
<html>
<head>
    <title>Avatar Ultra-Preciso V3 - Pose-T Calibration</title>
    <style>
        body { margin: 0; background-color: #00ff00; overflow: hidden; }
        #webcam { position: absolute; bottom: 10px; right: 10px; width: 160px; transform: scaleX(-1); border: 2px solid white; border-radius: 5px; opacity: 0.5; }
        #ui-container { position: absolute; top: 10px; left: 10px; display: flex; flex-direction: column; gap: 8px; z-index: 100; }
        .btn-reset { padding: 12px 20px; background: #00a8ff; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 4px #0097e6; }
        .btn-reset:active { box-shadow: 0 2px #0097e6; transform: translateY(2px); }
        #status { color: white; background: rgba(0,0,0,0.8); padding: 10px; font-family: 'Segoe UI', sans-serif; border-radius: 8px; border-left: 4px solid #00a8ff; }
    </style>
</head>
<body>
    <div id="ui-container">
        <div id="status">Inicia en Pose-T para calibrar...</div>
        <button class="btn-reset" onclick="location.reload()">游댃 RECALIBRAR (POSE-T)</button>
    </div>
    <video id="webcam" autoplay playsinline></video>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        const videoElement = document.getElementById('webcam');
        const status = document.getElementById('status');

        const scene = new THREE.Scene();
        const camera3D = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const mat = new THREE.MeshNormalMaterial();
        const avatar = new THREE.Group();
        
        // --- CUERPO ---
        const cabeza = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.4, 0.25), mat);
        avatar.add(cabeza);

        const tronco = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.7, 0.2), mat);
        tronco.position.y = -0.6;
        avatar.add(tronco);

        // --- BRAZOS Y MANOS ---
        function crearBrazoCompleto() {
            const hombro = new THREE.Group();
            const superior = new THREE.Mesh(new THREE.CylinderGeometry(0.04, 0.035, 0.4), mat);
            superior.geometry.translate(0, -0.2, 0);
            
            const codo = new THREE.Group();
            codo.position.y = -0.4;
            const inferior = new THREE.Mesh(new THREE.CylinderGeometry(0.035, 0.03, 0.4), mat);
            inferior.geometry.translate(0, -0.2, 0);
            
            const manoContainer = new THREE.Group();
            manoContainer.position.y = -0.4;
            
            codo.add(inferior, manoContainer);
            hombro.add(superior, codo);
            return { hombro, codo, manoContainer };
        }

        const bDer = crearBrazoCompleto(); bDer.hombro.position.set(-0.3, -0.3, 0);
        const bIzq = crearBrazoCompleto(); bIzq.hombro.position.set(0.3, -0.3, 0);
        avatar.add(bDer.hombro, bIzq.hombro);

        // Dedos anclados a la mano
        const dedosDer = [];
        for(let i=0; i<5; i++) {
            const d = new THREE.Mesh(new THREE.SphereGeometry(0.02), mat);
            bDer.manoContainer.add(d);
            dedosDer.push(d);
        }

        scene.add(avatar);
        camera3D.position.set(0, -0.4, 2.5);

        // --- TRACKING ---
        const holistic = new Holistic({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`});
        holistic.setOptions({ modelComplexity: 1, smoothLandmarks: true, refineFaceLandmarks: true });

        holistic.onResults((res) => {
            status.innerText = "Tracking: ALTA PRECISI칍N";

            // Cabeza
            if (res.faceLandmarks) {
                const n = res.faceLandmarks[1];
                cabeza.rotation.y = THREE.MathUtils.lerp(cabeza.rotation.y, (n.x - 0.5) * -1.5, 0.2);
                cabeza.rotation.x = THREE.MathUtils.lerp(cabeza.rotation.x, (n.y - 0.5) * 1.5, 0.2);
            }

            // Pose (Brazos)
            if (res.poseLandmarks) {
                moverBrazo(res.poseLandmarks[11], res.poseLandmarks[13], res.poseLandmarks[15], bDer, -1);
                moverBrazo(res.poseLandmarks[12], res.poseLandmarks[14], res.poseLandmarks[16], bIzq, 1);
            }

            // Manos (Relativas a la mu침eca)
            if (res.leftHandLandmarks) { // MediaPipe invierte manos a veces
                actualizarDedos(res.leftHandLandmarks, dedosDer);
            }
        });

        function moverBrazo(h, c, m, miembro, lado) {
            // Rotaci칩n Hombro
            const angH = Math.atan2(c.y - h.y, (c.x - h.x) * lado) + Math.PI/2;
            miembro.hombro.rotation.z = THREE.MathUtils.lerp(miembro.hombro.rotation.z, angH * lado, 0.3);
            
            // Rotaci칩n Codo
            const angC = Math.atan2(m.y - c.y, (m.x - c.x) * lado) - angH + Math.PI/2;
            miembro.codo.rotation.z = THREE.MathUtils.lerp(miembro.codo.rotation.z, angC * lado, 0.3);
        }

        function actualizarDedos(puntos, esferas) {
            const base = puntos[0]; // Mu침eca
            [4, 8, 12, 16, 20].forEach((id, i) => {
                // Calculamos la posici칩n relativa a la mu침eca y escalamos
                esferas[i].position.x = (puntos[id].x - base.x) * -2;
                esferas[i].position.y = (puntos[id].y - base.y) * -2;
                esferas[i].position.z = (puntos[id].z - base.z) * 2;
            });
        }

        const camera = new Camera(videoElement, {
            onFrame: async () => { await holistic.send({image: videoElement}); },
            width: 1280, height: 720
        });
        camera.start();

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera3D);
        }
        animate();
    </script>
</body>
</html>
