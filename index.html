<!DOCTYPE html>
<html>
<head>
    <title>Avatar - Modo Depuración Total</title>
    <style>
        body { margin: 0; background-color: #00ff00; overflow: hidden; }
        #webcam { position: absolute; bottom: 10px; right: 10px; width: 200px; transform: scaleX(-1); border: 3px solid red; }
        #status { position: absolute; top: 10px; left: 10px; color: white; background: black; padding: 10px; font-family: monospace; z-index: 100; }
    </style>
</head>
<body>
    <div id="status">ESTADO: INICIANDO CAPTURA DIRECTA...</div>
    <video id="webcam" autoplay playsinline></video>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        const videoElement = document.getElementById('webcam');
        const status = document.getElementById('status');

        const scene = new THREE.Scene();
        const camera3D = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: false, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const material = new THREE.MeshNormalMaterial();
        
        // Avatar simplificado para evitar errores de jerarquía
        const cabeza = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.5, 0.3), material);
        const tronco = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.9, 0.2), material);
        tronco.position.y = -0.7;
        
        const brazoD = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, 0.8), material);
        const brazoI = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, 0.8), material);

        scene.add(cabeza, tronco, brazoD, brazoI);
        camera3D.position.z = 3;

        const holistic = new Holistic({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`});
        
        // CONFIGURACIÓN AGRESIVA
        holistic.setOptions({
            modelComplexity: 1,
            smoothLandmarks: false, // Desactivamos suavizado para ver el movimiento real
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        holistic.onResults((res) => {
            if (!res.poseLandmarks) {
                status.innerText = "ERROR: NO TE VEO. ALÉJATE DE LA CÁMARA";
                return;
            }
            status.innerText = "TRACKING: RECIBIENDO COORDENADAS";

            // MOVIMIENTO DIRECTO (Sin rotaciones raras)
            const d = res.poseLandmarks;

            // Cabeza
            cabeza.position.x = (d[0].x - 0.5) * -3;
            cabeza.position.y = (d[0].y - 0.5) * -3;

            // Brazo Derecho (Tu izquierda)
            if (d[13] && d[15]) {
                brazoD.position.x = (d[13].x - 0.5) * -3;
                brazoD.position.y = (d[13].y - 0.5) * -3;
                // Apuntar el brazo hacia la muñeca
                brazoD.lookAt((d[15].x - 0.5) * -3, (d[15].y - 0.5) * -3, 0);
                brazoD.rotation.x += Math.PI / 2;
            }

            // Brazo Izquierdo (Tu derecha)
            if (d[14] && d[16]) {
                brazoI.position.x = (d[14].x - 0.5) * -3;
                brazoI.position.y = (d[14].y - 0.5) * -3;
                brazoI.lookAt((d[16].x - 0.5) * -3, (d[16].y - 0.5) * -3, 0);
                brazoI.rotation.x += Math.PI / 2;
            }
        });

        const camera = new Camera(videoElement, {
            onFrame: async () => { await holistic.send({image: videoElement}); },
            width: 640, height: 480
        });
        camera.start();

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera3D);
        }
        animate();
    </script>
</body>
</html>
